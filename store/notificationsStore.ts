import{create}from'zustand';import{persist,createJSONStorage}from'zustand/middleware';import AsyncStorage from'@react-native-async-storage/async-storage';export type NotificationType='streak'|'achievement'|'reminder'|'update'|'message'|'credits'|'leaderboard'|'gift';export interface NotificationAction{label:string;callback:(()=>void)|null;deeplink?:string;}export interface Notification{id:string;userId:string;type:NotificationType;title:string;body:string;icon:string;deeplink?:string;createdAt:number;scheduledFor?:number;isRead:boolean;action?:NotificationAction;}interface NotificationsState{notifications:Notification[];enabled:boolean;streakReminderTime:string;achievementNotifications:boolean;pushNotifications:boolean;unreadCount:number;lastNotificationId:string|null;scheduleNotification:(notification:Omit<Notification,'id'> extends infer T?{[K in keyof T]:T[K]}:never)=>Promise<string>;getNotifications:(userId:string,limit?:number)=>Notification[];markAsRead:(notificationId:string)=>Promise<void>;markAllAsRead:(userId:string)=>Promise<void>;deleteNotification:(notificationId:string)=>Promise<void>;clearAll:(userId:string)=>Promise<void>;sendPushNotification:(userId:string,notification:Omit<Notification,'id'>)=>Promise<void>;updateUserSettings:(userId:string,settings:Partial<NotificationSettings>)=>Promise<void>;getNotificationCount:(userId:string)=>Promise<number>;getUnreadCount:(userId:string)=>number;hasUnReadNotifications:(userId:string)=>boolean;getNotificationStats:(userId:string)=>{total:number,unread:number,read:number,byType:Record<NotificationType,number>};}export interface NotificationSettings{enabled:boolean;streakReminderTime:string;achievementNotifications:boolean;pushNotifications:boolean;weeklyDigest:boolean;milestoneAlerts:boolean;doNotDisturb:{enabled:boolean;startTime:string;endTime:string};}export const useNotificationsStore=create<NotificationsState>()(persist((set,get)=>({notifications:[],enabled:true,streakReminderTime:'10:00',achievementNotifications:true,pushNotifications:true,unreadCount:0,lastNotificationId:null,scheduleNotification:async(notificationData)=>{const id=`notif-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;const notification:Notification={id,...notificationData,createdAt:Date.now(),isRead:false,};set(state=>({notifications:[notification,...state.notifications.filter(n=>n.userId===notificationData.userId)],unreadCount:!notificationData.isRead?state.unreadCount+1:state.unreadCount,lastNotificationId:id}));return id;},getNotifications:(userId,limit=10)=>{const userNotifs=get().notifications.filter(n=>n.userId===userId);const sorted=[...userNotifs].sort((a,b)=>b.createdAt-a.createdAt);return limit?sorted.slice(0,limit):sorted;},markAsRead:async(notificationId)=>{set(state=>{const notif=state.notifications.find(n=>n.id===notificationId);if(!notif||notif.isRead)return state;const updatedNotifs=state.notifications.map(n=>n.id===notificationId?{...n,isRead:true}:n);return{notifications:updatedNotifs,unreadCount:Math.max(0,state.unreadCount-1)};});},markAllAsRead:async(userId)=>{set(state=>{const updatedNotifs=state.notifications.map(n=>n.userId===userId?{...n,isRead:true}:n);return{notifications:updatedNotifs,unreadCount:0};});},deleteNotification:async(notificationId)=>{set(state=>{const notif=state.notifications.find(n=>n.id===notificationId);const updatedNotifs=state.notifications.filter(n=>n.id!==notificationId);return{notifications:updatedNotifs,unreadCount:notif&&!notif.isRead?Math.max(0,state.unreadCount-1):state.unreadCount};});},clearAll:async(userId)=>{set(state=>{const userNotifs=get().notifications.filter(n=>n.userId===userId);const unreadCount=userNotifs.filter(n=>!n.isRead).length;return{notifications:state.notifications.filter(n=>n.userId!==userId),unreadCount:state.unreadCount-unreadCount};});},sendPushNotification:async(userId,notificationData)=>{const id=`push-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;const notification:Notification={id,userId,...notificationData,createdAt:Date.now(),isRead:false};set(state=>{const notifications=[notification,...state.notifications];return{notifications,unreadCount:state.unreadCount+1,lastNotificationId:id}});return notification;},updateUserSettings:async(userId,settings)=>{set(state=>({...state,...settings}));},getNotificationCount:async(userId)=>get().getNotifications(userId).length,getUnreadCount:(userId)=>{const userNotifs=get().notifications.filter(n=>n.userId===userId);return userNotifs.filter(n=>!n.isRead).length;},hasUnReadNotifications:(userId)=>get().getUnreadCount(userId)>0,getNotificationStats:(userId)=>{const userNotifs=get().notifications.filter(n=>n.userId===userId);const byType=userNotifs.reduce((acc,notif)=>{acc[notif.type]=(acc[notif.type]||0)+1;return acc},{}as Record<NotificationType,number>);return{total:userNotifs.length,unread:userNotifs.filter(n=>!n.isRead).length,read:userNotifs.filter(n=>n.isRead).length,byType};},}),{name:'learnsmart-notifications',storage:createJSONStorage(()=>AsyncStorage),version:1}));export function useNotificationScheduler(){const scheduleStreakReminder=async(userId:string,streakDays:number,reminderTime:string='10:00')=>{const store=useNotificationsStore.getState();if(!store.enabled)return;const[hour,minute]=reminderTime.split(':');const now=new Date();const scheduledTime=new Date(now.getFullYear(),now.getMonth(),now.getDate(),parseInt(hour,10),parseInt(minute,10));if(scheduledTime<now){scheduledTime.setDate(scheduledTime.getDate()+1)}return store.scheduleNotification({userId,type:'streak',title:'\u26a1 Keep your streak alive!',body:`Study for 5 minutes to maintain your ${streakDays}-day streak!`,icon:'\ud83d\udd25',scheduledFor:scheduledTime.getTime()});};const scheduleAchievementNotification=async(userId:string,achievementId:string,achievementTitle:string)=>{const store=useNotificationsStore.getState();if(!store.achievementNotifications)return;return store.scheduleNotification({userId,type:'achievement',title:`\ud83c\udfc6 Achievement Unlocked!`,body:`You unlocked "${achievementTitle}"`,icon:'\ud83c\udfc6'});};const scheduleWeeklyDigest=async(userId:string,weekStats:{lessonsCompleted:number,quizzesPassed:number,timeStudied:number})=>{const store=useNotificationsStore.getState();if(!store.weeklyDigest)return;const{lessonsCompleted,quizzesPassed,timeStudied}=weekStats;return store.scheduleNotification({userId,type:'update',title:'\ud83d\udcca Your Weekly Report',body:`${lessonsCompleted} lessons • ${quizzesPassed} quizzes • ${timeStudied}h studied`,icon:'\ud83d\udcca'});};const sendMilestoneAlert=async(userId:string,milestone:string,value:number)=>{const store=useNotificationsStore.getState();if(!store.milestoneAlerts)return;return store.sendPushNotification(userId,{type:'milestone',title:'\ud83c\udfaf Milestone Reached!',body:`${milestone}: ${value}`,icon:'\ud83c\udfaf'});};return{scheduleStreakReminder,scheduleAchievementNotification,scheduleWeeklyDigest,sendMilestoneAlert}}export default useNotificationsStore;